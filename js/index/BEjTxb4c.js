import{j as e,r as l}from"../vendor/react/DhsTxFA8.js";import{c as Q}from"../vendor/react-dom/CZFdF-fi.js";import{F as $,a as O,b as k}from"../vendor/formik/CPBHfKc5.js";import{c as F,a as U,b as X}from"../vendor/yup/DXiknSmE.js";import{a as q}from"../vendor/axios/C0ehD9Ac.js";import{u as b,N as Z,R as ee,a as A,B as se}from"../vendor/react-router/COCdTuiB.js";import{M as E,a as ne,b as I,c as C}from"../vendor/react-icons/n57J5egk.js";import"../vendor/cookie/CqkleIqs.js";import"../vendor/scheduler/efY9L43x.js";import"../vendor/deepmerge/DhIoniG1.js";import"../vendor/lodash-es/Bw_lT_GB.js";import"../vendor/react-fast-compare/DlNu-obT.js";import"../vendor/hoist-non-react-statics/CjKdNK1C.js";import"../vendor/react-is/CnyDuYXe.js";import"../vendor/property-expr/DwgEMw67.js";import"../vendor/tiny-case/Gl8mQWqo.js";import"../vendor/toposort/BhET8mSu.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function a(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function i(r){if(r.ep)return;r.ep=!0;const t=a(r);fetch(r.href,t)}})();const p=({className:s,dataTheme:n,onClick:a,children:i,type:r="button",disabled:t=!1})=>e.jsx("button",{className:s,"data-theme":n,onClick:a,type:r,disabled:t,children:i}),te="https://34.51.235.234",re=q.create({baseURL:te,withCredentials:!0}),oe=()=>"https://34.51.235.234".split(",").map(n=>n.trim()),ae=async s=>{try{const n=new AbortController,a=setTimeout(()=>n.abort(),500);if(s==="/"||s==="")return clearTimeout(a),console.log("Api proxy available at /"),!0;const i=s.endsWith("/")?s.slice(0,-1):s;return await re.get(i,{signal:n.signal,timeout:2e3}),clearTimeout(a),console.log(`Api avaible: ${s}`),!0}catch{return console.log(`Api unavaible: ${s}`),!1}},ie=async()=>{const s=oe();console.log("Search working API in:",s);const a=(await Promise.allSettled(s.map(async i=>{if(await ae(i))return i;throw new Error(`${i} is not avaible`)}))).find(i=>i.status==="fulfilled");if(a){const i=a.value.endsWith("/")?a.value:a.value+"/";return console.log("Use Api: ",i),i}return console.warn("All APIs are not avaibles, return fallback",s[0]),s[0].endsWith("/")?s[0]:s[0]+"/"};let P=null;const B=async()=>P||(P=await ie(),P);let L=null,W=null;const ce=async()=>(L||(L=await B()),L),le=async()=>(L||await ce(),L),V=async()=>{if(!W){const s=await le();W=q.create({baseURL:s,withCredentials:!0,headers:{"Content-Type":"application/json"}})}return W},J=async s=>{try{return(await(await V()).post("auth/login",{username:s.username,password:s.password})).data}catch(n){throw console.log("Something wrong, "+n),n}},de=async s=>{try{return(await(await V()).post("auth/register",{username:s.username,password:s.password})).data}catch(n){throw console.log("Something wrong, "+n),n}},D=l.createContext(),ue=({children:s})=>{const[n,a]=l.useState(null),[i,r]=l.useState(!1),[t,o]=l.useState(!0),m=d=>{a(d),r(!0),localStorage.setItem("user",JSON.stringify(d))},c=()=>{a(null),r(!1),localStorage.removeItem("user")};l.useEffect(()=>{const d=localStorage.getItem("user");d&&(a(JSON.parse(d)),r(!0)),o(!1)},[]);const g=l.useMemo(()=>({user:n,isAuthenticated:i,login:m,logout:c,loading:t}),[n,i]);return e.jsx(D.Provider,{value:g,children:s})},_=()=>l.useContext(D),G=l.createContext(null),me=()=>{if(typeof window=="undefined")return"light";const s=localStorage.getItem("theme");if(s==="dark"||s==="light")return s;const n=typeof window.matchMedia=="function"?window.matchMedia("(prefers-color-scheme: dark)"):null;return n!=null&&n.matches?"dark":"light"},ge=({children:s})=>{const[n,a]=l.useState(me);l.useEffect(()=>{document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n)},[n]),l.useEffect(()=>{const t=typeof window.matchMedia=="function"?window.matchMedia("(prefers-color-scheme: dark)"):null;if(!t)return;const o=m=>{a(m.matches?"dark":"light")};return t.addEventListener?t.addEventListener("change",o):t.addListener&&t.addListener(o),()=>{t.removeEventListener?t.removeEventListener("change",o):t.removeListener&&t.removeListener(o)}},[]);const i=()=>{a(t=>t==="dark"?"light":"dark")},r=l.useMemo(()=>({theme:n,toggleTheme:i}),[n]);return e.jsx(G.Provider,{value:r,children:s})},M=()=>{const s=l.useContext(G);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s},K=l.createContext(),he=({children:s})=>{const{user:n,isAuthenticated:a}=_(),[i,r]=l.useState([]),[t,o]=l.useState(!1),[m,c]=l.useState([]),g=l.useRef(null),d=l.useRef(!0),x=l.useRef(0),N=5,u=l.useRef(new Map);l.useEffect(()=>(a&&n?(console.log("Attempting WebSocket connection for user:",n.username),d.current=!0,x.current=0,w()):(d.current=!1,x.current=0,R()),()=>{d.current=!1,x.current=0,R()}),[a,n]);const w=async()=>{try{const v=await B();if(!v){console.error("No working API found");return}const S=((j,h)=>{let f;try{f=new URL(j)}catch{f=new URL(j,window.location.origin)}f.protocol=f.protocol==="https:"?"wss:":"ws:";const y=f.pathname.replace(/\/+$/,"");return f.pathname=`${y}/ws/${h}`,f.toString()})(v,n.id);console.log("Connecting to WebSocked:",S),g.current=new WebSocket(S),g.current.onopen=()=>{console.log("WebSocket Connected"),o(!0),x.current=0},g.current.onmessage=j=>{const h=JSON.parse(j.data);if(console.log("WebSocket message received:",h),h.type==="online_users")console.log("Updating online users:",h.users),r(h.users);else if(h.type==="chat_message"){const f={id:h.message_id,senderId:h.sender_id,recipientId:h.recipient_id,content:h.content,timestamp:h.timestamp};c(y=>[...y,f]),u.current.forEach(y=>y(f))}else h.type==="message_sent"&&console.log("Message sent confirmation:",h.message_id)},g.current.onerror=j=>{console.error("WebSocket ERROR:",j)},g.current.onclose=j=>{console.log("WebSocket CLOSED:",j.code,j.reason),o(!1),d.current&&a&&n?x.current<N?(x.current+=1,console.log(`Attempting to reconnect in 3 seconds... (Attempt ${x.current}/${N})`),setTimeout(()=>{w()},3e3)):(console.warn(`Maximum reconnection attempts (${N}) reached. Giving up.`),d.current=!1):console.log("Reconnect disabled (user logged out or max attempts reached)")}}catch(v){console.error("Failed to connect WebSocket:",v)}},z=l.useCallback((v,T)=>{if(g.current&&g.current.readyState===WebSocket.OPEN){const S={type:"chat_message",recipient_id:v,content:T,timestamp:new Date().toISOString(),message_id:Date.now()};g.current.send(JSON.stringify(S)),console.log("Message sent:",S)}else console.error("WebSocket is not connected")},[]),R=()=>{g.current&&(console.log("Disconnecting WebSocket"),g.current.close(),g.current=null,o(!1),r([]))},H={onlineUsers:i,isConnected:t,sendMessage:z,messages:m,setMessages:c};return e.jsx(K.Provider,{value:H,children:s})},Y=()=>l.useContext(K),pe=F({username:U().min(6,"Use minimum 6 symbols").required("Enter login"),password:U().min(6,"Use minimum 6 symbols").required("Enter password")}),fe=()=>{const s=b(),{login:n}=_(),a=async(i,{setSubmitting:r,setErrors:t})=>{try{const o=await J(i);console.log("Successfull response from server:",o.user),o.status==="success"?(console.log("Login Successfull:",o.user.username),n(o.user),s("/messenger")):(console.log("Login failed"),t({submit:"Wrong login or password"})),r(!1)}catch(o){console.error("Login error:",o),t({submit:"Login failed"}),r(!1)}};return e.jsx($,{initialValues:{username:"",password:""},validationSchema:pe,onSubmit:a,children:({isSubmitting:i,errors:r})=>e.jsxs(O,{children:[e.jsx("div",{className:"form_title",children:"Enter login and password"}),e.jsx(k,{name:"username",children:({field:t,meta:o})=>e.jsx("div",{className:`login_label ${o.touched&&o.error?"input-error":""}`,children:e.jsx("input",{...t,type:"text",placeholder:o.touched&&o.error?o.error:"Username"})})}),e.jsx(k,{name:"password",children:({field:t,meta:o})=>e.jsx("div",{className:`password_label ${o.touched&&o.error?"input-error":""}`,children:e.jsx("input",{...t,type:"password",placeholder:o.touched&&o.error?o.error:"Password"})})}),r.submit&&e.jsx("div",{className:"error_message submit_error",children:r.submit}),e.jsx(p,{className:"btn log_in_btn",type:"submit",disabled:i,children:i?"Loading...":"Log In"})]})})},xe=F({username:U().min(6,"Use minimum 6 symbols").max(20,"Use max 20 symbols").required("Enter login"),password:U().min(6,"Use minimum 6 symbols").max(20,"Use max 20 symbols").required("Enter password"),confirmPassword:U().oneOf([X("password"),null],"Passwords is not same").required("Confirm password")}),je=()=>{const s=b(),{login:n}=_(),[a,i]=l.useState(!1),r=async(t,{setSubmitting:o,setErrors:m,resetForm:c})=>{i(!0);try{const g=await de(t),d=await J(t);console.log("Successfull response from server:",d.user),d.status==="success"?(console.log("Login Successfull:",d.user.username),n(d.user,d.access_token),s("/messenger")):(console.log("Login failed"),m({submit:"Wrong login or password"})),c()}catch(g){console.error("Failed to create user:",g)}finally{i(!1),o(!1)}};return e.jsx($,{initialValues:{username:"",password:"",confirmPassword:""},validationSchema:xe,onSubmit:r,children:({isSubmitting:t,errors:o})=>e.jsxs(O,{children:[e.jsx("div",{className:"form_title",children:"Create account"}),e.jsx(k,{name:"username",children:({field:m,meta:c})=>e.jsx("div",{className:`login_label ${c.touched&&c.error?"input-error":""}`,children:e.jsx("input",{...m,type:"text",placeholder:c.touched&&c.error?c.error:"Username"})})}),e.jsx(k,{name:"password",children:({field:m,meta:c})=>e.jsx("div",{className:`password_label ${c.touched&&c.error?"input-error":""}`,children:e.jsx("input",{...m,type:"password",placeholder:c.touched&&c.error?c.error:"Password"})})}),e.jsx(k,{name:"confirmPassword",children:({field:m,meta:c})=>e.jsx("div",{className:`password_label ${c.touched&&c.error?"input-error":""}`,children:e.jsx("input",{...m,type:"password",placeholder:c.touched&&c.error?c.error:"Confirm Password"})})}),o.submit&&e.jsx("div",{className:"error_message submit_error",children:o.submit}),e.jsx(p,{className:"btn sign_up_btn",type:"submit",disabled:a,children:a?"Wait...":"Sign Up"})]})})},we=({userName:s="Unknown",onClick:n,isActive:a})=>{const i=()=>{const r=s.trim().split(/\s+/);return r.length>=2?(r[0][0]+r[1][0]).toUpperCase():s.length>=2?s.slice(0,2).toUpperCase():s.toUpperCase()};return e.jsxs("div",{className:`contact_card_container ${a?"active":""}`,onClick:n,style:{cursor:"pointer"},children:[e.jsx("div",{className:"contact_card_container_ico",children:i()}),e.jsx("div",{className:"contact_card_container_name",children:s})]})},be=({selectedContact:s,onClose:n})=>{const{sendMessage:a,messages:i,onlineUsers:r}=Y(),{user:t}=_(),[o,m]=l.useState(""),c=l.useMemo(()=>{const u=new Map;return t&&u.set(t.id,t.username),s&&u.set(s.id,s.username),Array.isArray(r)&&r.forEach(w=>{w!=null&&w.id&&u.set(w.id,w.username)}),u},[r,t,s]),g=u=>u?c.get(u)||`User ${u}`:"Unknown",d=i.filter(u=>u.senderId===t.id&&u.recipientId===(s==null?void 0:s.id)||u.senderId===(s==null?void 0:s.id)&&u.recipientId===t.id),x=()=>{if(typeof n=="function"){n();return}},N=()=>{if(!s){alert("Choose contact");return}o.trim()&&(a(s.id,o),m(""))};return s?e.jsxs("div",{className:"messeges_window",children:[e.jsx("div",{className:"messeges_history",children:d.map(u=>e.jsxs("div",{className:`message ${u.senderId===t.id?"sent":"received"}`,children:[e.jsx("div",{className:"message_sender",children:g(u.senderId)}),e.jsx("div",{className:"message_timestamp",children:new Date(u.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})}),e.jsx("div",{className:"message_content",children:u.content})]},u.id))}),e.jsxs("div",{className:"action_bar",children:[e.jsx(p,{className:"btn back_btn",onClick:x,children:e.jsx(E,{className:"material-icons"})}),e.jsx("input",{className:"message_input",value:o,onChange:u=>m(u.target.value),placeholder:"Enter message"}),e.jsx(p,{className:"btn send_message_btn",onClick:N,children:e.jsx(ne,{})})]})]}):e.jsx("div",{className:"messeges_window",children:e.jsx("div",{className:"no_contact_selected",children:"Choose user for communicate"})})},ve=()=>{const s=b(),{theme:n,toggleTheme:a}=M();return e.jsxs("div",{className:"welcome_page",id:"welcomePage",children:[e.jsx("nav",{className:"nav_line",id:"navLine",children:e.jsx(p,{className:"btn change_theme_btn",dataTheme:n,onClick:a,children:n==="dark"?e.jsx(I,{className:"theme_ico"}):e.jsx(C,{className:"theme_ico"})})}),e.jsxs("div",{className:"welcome_page_container",children:[e.jsx("div",{className:"welcome_page_title",children:"TrustMess"}),e.jsx(p,{className:"btn sign_up_btn",onClick:()=>s("/signup"),children:"Sign Up"}),e.jsx(p,{className:"btn log_in_btn",onClick:()=>s("/login"),children:"Log In"})]})]})},_e=()=>{const s=b(),{theme:n,toggleTheme:a}=M();return e.jsxs("div",{className:"login_page",id:"loginPage",children:[e.jsx("nav",{className:"nav_line",id:"navLine",children:e.jsx(p,{className:"btn change_theme_btn",dataTheme:n,onClick:a,children:n==="dark"?e.jsx(I,{className:"theme_ico"}):e.jsx(C,{className:"theme_ico"})})}),e.jsx(fe,{}),e.jsx(p,{className:"btn back_btn",onClick:()=>s("/"),children:e.jsx(E,{className:"material-icons"})})]})},Ne=()=>{const s=b(),{theme:n,toggleTheme:a}=M();return e.jsxs("div",{className:"signup_page",id:"signupPage",children:[e.jsx("nav",{className:"nav_line",id:"navLine",children:e.jsx(p,{className:"btn change_theme_btn",dataTheme:n,onClick:a,children:n==="dark"?e.jsx(I,{className:"theme_ico"}):e.jsx(C,{className:"theme_ico"})})}),e.jsx(je,{}),e.jsx(p,{className:"btn back_btn",onClick:()=>s("/"),children:e.jsx(E,{className:"material-icons"})})]})},Se=()=>{const{user:s,isAuthenticated:n,logout:a}=_(),{theme:i,toggleTheme:r}=M(),t=b(),{onlineUsers:o,isConnected:m}=Y(),[c,g]=l.useState(null);return console.log("Online users:",o),console.log("Connected:",m),m?e.jsxs("div",{className:"messenger_page",children:[e.jsxs("nav",{className:"nav_line",id:"navLine",children:[e.jsxs("div",{className:"auth_user_div",children:[s==null?void 0:s.username," "]}),e.jsx("div",{className:"online_status_div",children:m?"Online":"Offline"}),e.jsx(p,{className:"btn change_theme_btn",dataTheme:i,onClick:r,children:i==="dark"?e.jsx(I,{className:"theme_ico"}):e.jsx(C,{className:"theme_ico"})}),e.jsx(p,{className:"btn btn_log_out",onClick:()=>{a(),t("/")},children:"Log out"})]}),e.jsxs("main",{className:`messenger_container ${c?"chat_open":""}`,children:[e.jsx("div",{className:"contacts_panel",children:m?o.length===0?e.jsx("div",{className:"no-users-message",children:"No users online"}):o.filter(d=>d.id!==s.id).map(d=>e.jsx(we,{userName:d.username,onClick:()=>g(d),isActive:(c==null?void 0:c.id)===d.id},d.id)):e.jsx("div",{className:"connecting-message",children:"Connecting to server..."})}),e.jsx("div",{className:"dialog_panel",children:e.jsx(be,{className:"messeges_window",selectedContact:c,onClose:()=>g(null)})})]})]}):e.jsx("div",{children:"Loading..."})},ye=({children:s})=>{const{isAuthenticated:n,loading:a}=_(),i=b(),r=()=>{console.log("return to log in page"),i("/login")};return a?e.jsxs("div",{className:"loading_page",id:"loadingPage",children:[e.jsx("div",{className:"loading_circle",children:e.jsx("div",{className:"loading_text",children:"Loading..."})}),e.jsx("button",{className:"btn",onClick:r,children:"Return back"})]}):n?s:(console.log("You are not log in"),e.jsx(Z,{to:"/login",replace:!0}))},ke=()=>e.jsxs(ee,{children:[e.jsx(A,{path:"/",element:e.jsx(ve,{})}),e.jsx(A,{path:"/login",element:e.jsx(_e,{})}),e.jsx(A,{path:"/signup",element:e.jsx(Ne,{})}),e.jsx(A,{path:"/messenger",element:e.jsx(ye,{children:e.jsx(Se,{})})})]});Q.createRoot(document.getElementById("root")).render(e.jsx(l.StrictMode,{children:e.jsx(se,{basename:"/",children:e.jsx(ue,{children:e.jsx(ge,{children:e.jsx(he,{children:e.jsx(ke,{})})})})})}));
